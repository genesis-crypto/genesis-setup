name: Extract Content

on: 
  issues:
    types: [opened, reopened]

jobs:
  extract-content:
    runs-on: ubuntu-latest
    steps:
    - name: Install pandoc
      run: sudo apt-get install pandoc -y
    
    - name: Install jq
      run: sudo apt-get install jq -y

    - name: Restore cache
      uses: actions/cache@v2
      with:
        path: output.json
        key: ${{ runner.os }}-pandoc-${{ hashFiles('**/output.json') }}
        restore-keys: |
          ${{ runner.os }}-pandoc-
          
    - name: Convert markdown to JSON
      run: |
        issue_body="${{ github.event.issue.body }}"
        pandoc -s -f markdown -t json <(echo "$issue_body") > output.json
      shell: bash

    - name: Extract values from JSON
      run: |
        repo=$(cat output.json | jq -r '.blocks[] | select(.t == "Para") | .c[0].c[0].text')
        setup=$(cat output.json | jq -r '.blocks[] | select(.t == "Para") | .c[1].c[0].text')
        echo "::set-output name=genesis_setup::$genesis_setup"
        echo "::set-output name=genesis_template_node::$genesis_template_node"

    - name: Save values to cache
      uses: actions/cache@v2
      with:
        path: output.json
        key: ${{ runner.os }}-genesis_values-${{ hashFiles('**/output.json') }}
        restore-keys: |
          ${{ runner.os }}-genesis_values-
        actions: save
        value-outputs: |
          repo
          setup
